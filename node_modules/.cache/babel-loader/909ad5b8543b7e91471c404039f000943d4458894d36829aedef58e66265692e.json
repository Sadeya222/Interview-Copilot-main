{"ast":null,"code":"// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT license.\nimport { ObjectDisposedError } from \"./Error.js\";\nimport { createNoDashGuid } from \"./Guid.js\";\nexport class EventSource {\n  constructor(metadata) {\n    this.privEventListeners = {};\n    this.privIsDisposed = false;\n    this.privConsoleListener = undefined;\n    this.privMetadata = metadata;\n  }\n  onEvent(event) {\n    if (this.isDisposed()) {\n      throw new ObjectDisposedError(\"EventSource\");\n    }\n    if (this.metadata) {\n      for (const paramName in this.metadata) {\n        if (paramName) {\n          if (event.metadata) {\n            if (!event.metadata[paramName]) {\n              event.metadata[paramName] = this.metadata[paramName];\n            }\n          }\n        }\n      }\n    }\n    for (const eventId in this.privEventListeners) {\n      if (eventId && this.privEventListeners[eventId]) {\n        this.privEventListeners[eventId](event);\n      }\n    }\n  }\n  attach(onEventCallback) {\n    const id = createNoDashGuid();\n    this.privEventListeners[id] = onEventCallback;\n    return {\n      detach: () => {\n        delete this.privEventListeners[id];\n        return Promise.resolve();\n      }\n    };\n  }\n  attachListener(listener) {\n    return this.attach(e => listener.onEvent(e));\n  }\n  attachConsoleListener(listener) {\n    if (!!this.privConsoleListener) {\n      void this.privConsoleListener.detach(); // Detach implementation for eventListeners is synchronous\n    }\n\n    this.privConsoleListener = this.attach(e => listener.onEvent(e));\n    return this.privConsoleListener;\n  }\n  isDisposed() {\n    return this.privIsDisposed;\n  }\n  dispose() {\n    this.privEventListeners = null;\n    this.privIsDisposed = true;\n  }\n  get metadata() {\n    return this.privMetadata;\n  }\n}","map":{"version":3,"names":["ObjectDisposedError","createNoDashGuid","EventSource","constructor","metadata","privEventListeners","privIsDisposed","privConsoleListener","undefined","privMetadata","onEvent","event","isDisposed","paramName","eventId","attach","onEventCallback","id","detach","Promise","resolve","attachListener","listener","e","attachConsoleListener","dispose"],"sources":["src/common/EventSource.ts"],"sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT license.\r\n\r\nimport { ObjectDisposedError } from \"./Error.js\";\r\nimport { createNoDashGuid } from \"./Guid.js\";\r\nimport { IDetachable } from \"./IDetachable.js\";\r\nimport { IStringDictionary } from \"./IDictionary.js\";\r\nimport { IEventListener } from \"./IEventListener.js\";\r\nimport { IEventSource } from \"./IEventSource.js\";\r\nimport { PlatformEvent } from \"./PlatformEvent.js\";\r\n\r\nexport class EventSource<TEvent extends PlatformEvent> implements IEventSource<TEvent> {\r\n    private privEventListeners: IStringDictionary<(event: TEvent) => void> = {};\r\n    private privMetadata: IStringDictionary<string>;\r\n    private privIsDisposed: boolean = false;\r\n    private privConsoleListener: IDetachable = undefined;\r\n\r\n    public constructor(metadata?: IStringDictionary<string>) {\r\n        this.privMetadata = metadata;\r\n    }\r\n\r\n    public onEvent(event: TEvent): void {\r\n        if (this.isDisposed()) {\r\n            throw (new ObjectDisposedError(\"EventSource\"));\r\n        }\r\n\r\n        if (this.metadata) {\r\n            for (const paramName in this.metadata) {\r\n                if (paramName) {\r\n                    if (event.metadata) {\r\n                        if (!event.metadata[paramName]) {\r\n                            event.metadata[paramName] = this.metadata[paramName];\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        for (const eventId in this.privEventListeners) {\r\n            if (eventId && this.privEventListeners[eventId]) {\r\n                this.privEventListeners[eventId](event);\r\n            }\r\n        }\r\n    }\r\n\r\n    public attach(onEventCallback: (event: TEvent) => void): IDetachable {\r\n        const id = createNoDashGuid();\r\n        this.privEventListeners[id] = onEventCallback;\r\n        return {\r\n            detach: (): Promise<void> => {\r\n                delete this.privEventListeners[id];\r\n                return Promise.resolve();\r\n            },\r\n        };\r\n    }\r\n\r\n    public attachListener(listener: IEventListener<TEvent>): IDetachable {\r\n        return this.attach((e: TEvent): void => listener.onEvent(e));\r\n    }\r\n\r\n    public attachConsoleListener(listener: IEventListener<TEvent>): IDetachable {\r\n        if (!!this.privConsoleListener) {\r\n            void this.privConsoleListener.detach(); // Detach implementation for eventListeners is synchronous\r\n        }\r\n        this.privConsoleListener = this.attach((e: TEvent): void => listener.onEvent(e));\r\n        return this.privConsoleListener;\r\n    }\r\n\r\n    public isDisposed(): boolean {\r\n        return this.privIsDisposed;\r\n    }\r\n\r\n    public dispose(): void {\r\n        this.privEventListeners = null;\r\n        this.privIsDisposed = true;\r\n    }\r\n\r\n    public get metadata(): IStringDictionary<string> {\r\n        return this.privMetadata;\r\n    }\r\n}\r\n"],"mappings":"AAAA;AACA;AAEA,SAASA,mBAAmB,QAAQ,YAAY;AAChD,SAASC,gBAAgB,QAAQ,WAAW;AAO5C,OAAM,MAAOC,WAAW;EAMpBC,YAAmBC,QAAoC;IAL/C,KAAAC,kBAAkB,GAA+C,EAAE;IAEnE,KAAAC,cAAc,GAAY,KAAK;IAC/B,KAAAC,mBAAmB,GAAgBC,SAAS;IAGhD,IAAI,CAACC,YAAY,GAAGL,QAAQ;EAChC;EAEOM,OAAOA,CAACC,KAAa;IACxB,IAAI,IAAI,CAACC,UAAU,EAAE,EAAE;MACnB,MAAO,IAAIZ,mBAAmB,CAAC,aAAa,CAAC;;IAGjD,IAAI,IAAI,CAACI,QAAQ,EAAE;MACf,KAAK,MAAMS,SAAS,IAAI,IAAI,CAACT,QAAQ,EAAE;QACnC,IAAIS,SAAS,EAAE;UACX,IAAIF,KAAK,CAACP,QAAQ,EAAE;YAChB,IAAI,CAACO,KAAK,CAACP,QAAQ,CAACS,SAAS,CAAC,EAAE;cAC5BF,KAAK,CAACP,QAAQ,CAACS,SAAS,CAAC,GAAG,IAAI,CAACT,QAAQ,CAACS,SAAS,CAAC;;;;;;IAOxE,KAAK,MAAMC,OAAO,IAAI,IAAI,CAACT,kBAAkB,EAAE;MAC3C,IAAIS,OAAO,IAAI,IAAI,CAACT,kBAAkB,CAACS,OAAO,CAAC,EAAE;QAC7C,IAAI,CAACT,kBAAkB,CAACS,OAAO,CAAC,CAACH,KAAK,CAAC;;;EAGnD;EAEOI,MAAMA,CAACC,eAAwC;IAClD,MAAMC,EAAE,GAAGhB,gBAAgB,EAAE;IAC7B,IAAI,CAACI,kBAAkB,CAACY,EAAE,CAAC,GAAGD,eAAe;IAC7C,OAAO;MACHE,MAAM,EAAEA,CAAA,KAAoB;QACxB,OAAO,IAAI,CAACb,kBAAkB,CAACY,EAAE,CAAC;QAClC,OAAOE,OAAO,CAACC,OAAO,EAAE;MAC5B;KACH;EACL;EAEOC,cAAcA,CAACC,QAAgC;IAClD,OAAO,IAAI,CAACP,MAAM,CAAEQ,CAAS,IAAWD,QAAQ,CAACZ,OAAO,CAACa,CAAC,CAAC,CAAC;EAChE;EAEOC,qBAAqBA,CAACF,QAAgC;IACzD,IAAI,CAAC,CAAC,IAAI,CAACf,mBAAmB,EAAE;MAC5B,KAAK,IAAI,CAACA,mBAAmB,CAACW,MAAM,EAAE,CAAC,CAAC;;;IAE5C,IAAI,CAACX,mBAAmB,GAAG,IAAI,CAACQ,MAAM,CAAEQ,CAAS,IAAWD,QAAQ,CAACZ,OAAO,CAACa,CAAC,CAAC,CAAC;IAChF,OAAO,IAAI,CAAChB,mBAAmB;EACnC;EAEOK,UAAUA,CAAA;IACb,OAAO,IAAI,CAACN,cAAc;EAC9B;EAEOmB,OAAOA,CAAA;IACV,IAAI,CAACpB,kBAAkB,GAAG,IAAI;IAC9B,IAAI,CAACC,cAAc,GAAG,IAAI;EAC9B;EAEA,IAAWF,QAAQA,CAAA;IACf,OAAO,IAAI,CAACK,YAAY;EAC5B"},"metadata":{},"sourceType":"module","externalDependencies":[]}