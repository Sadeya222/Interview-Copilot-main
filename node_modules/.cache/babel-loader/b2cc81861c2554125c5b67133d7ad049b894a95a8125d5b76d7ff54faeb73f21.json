{"ast":null,"code":"// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT license.\nimport { AudioOutputFormatImpl } from \"../sdk/Audio/AudioOutputFormat.js\";\nimport { AudioOutputStream } from \"../sdk/Audio/AudioOutputStream.js\";\nimport { MessageDataStreamType } from \"./ServiceMessages/ActivityResponsePayload.js\";\nexport class DialogServiceTurnState {\n  constructor(manager, requestId) {\n    this.privRequestId = requestId;\n    this.privIsCompleted = false;\n    this.privAudioStream = null;\n    this.privTurnManager = manager;\n    this.resetTurnEndTimeout();\n  }\n  get audioStream() {\n    // Called when is needed to stream.\n    this.resetTurnEndTimeout();\n    return this.privAudioStream;\n  }\n  processActivityPayload(payload, audioFormat) {\n    if (payload.messageDataStreamType === MessageDataStreamType.TextToSpeechAudio) {\n      this.privAudioStream = AudioOutputStream.createPullStream();\n      this.privAudioStream.format = audioFormat !== undefined ? audioFormat : AudioOutputFormatImpl.getDefaultOutputFormat();\n    }\n    return this.privAudioStream;\n  }\n  endAudioStream() {\n    if (this.privAudioStream !== null && !this.privAudioStream.isClosed) {\n      this.privAudioStream.close();\n    }\n  }\n  complete() {\n    if (this.privTimeoutToken !== undefined) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      clearTimeout(this.privTimeoutToken);\n    }\n    this.endAudioStream();\n  }\n  resetTurnEndTimeout() {\n    if (this.privTimeoutToken !== undefined) {\n      // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\n      clearTimeout(this.privTimeoutToken);\n    }\n    this.privTimeoutToken = setTimeout(() => {\n      this.privTurnManager.CompleteTurn(this.privRequestId);\n      return;\n    }, 2000);\n  }\n}","map":{"version":3,"names":["AudioOutputFormatImpl","AudioOutputStream","MessageDataStreamType","DialogServiceTurnState","constructor","manager","requestId","privRequestId","privIsCompleted","privAudioStream","privTurnManager","resetTurnEndTimeout","audioStream","processActivityPayload","payload","audioFormat","messageDataStreamType","TextToSpeechAudio","createPullStream","format","undefined","getDefaultOutputFormat","endAudioStream","isClosed","close","complete","privTimeoutToken","clearTimeout","setTimeout","CompleteTurn"],"sources":["src/common.speech/DialogServiceTurnState.ts"],"sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved.\r\n// Licensed under the MIT license.\r\n\r\nimport { AudioOutputFormatImpl } from \"../sdk/Audio/AudioOutputFormat.js\";\r\nimport { AudioOutputStream, PullAudioOutputStreamImpl } from \"../sdk/Audio/AudioOutputStream.js\";\r\nimport { DialogServiceTurnStateManager } from \"./DialogServiceTurnStateManager.js\";\r\nimport { ActivityPayloadResponse, MessageDataStreamType } from \"./ServiceMessages/ActivityResponsePayload.js\";\r\n\r\nexport class DialogServiceTurnState {\r\n    private privRequestId: string;\r\n    private privIsCompleted: boolean;\r\n    private privAudioStream: PullAudioOutputStreamImpl;\r\n    private privTimeoutToken: any;\r\n    private privTurnManager: DialogServiceTurnStateManager;\r\n\r\n    public constructor(manager: DialogServiceTurnStateManager, requestId: string) {\r\n        this.privRequestId = requestId;\r\n        this.privIsCompleted = false;\r\n        this.privAudioStream = null;\r\n        this.privTurnManager = manager;\r\n        this.resetTurnEndTimeout();\r\n    }\r\n\r\n    public get audioStream(): PullAudioOutputStreamImpl {\r\n        // Called when is needed to stream.\r\n        this.resetTurnEndTimeout();\r\n        return this.privAudioStream;\r\n    }\r\n\r\n    public processActivityPayload(payload: ActivityPayloadResponse, audioFormat?: AudioOutputFormatImpl): PullAudioOutputStreamImpl {\r\n        if (payload.messageDataStreamType === MessageDataStreamType.TextToSpeechAudio) {\r\n            this.privAudioStream = AudioOutputStream.createPullStream() as PullAudioOutputStreamImpl;\r\n            this.privAudioStream.format = (audioFormat !== undefined) ? audioFormat : AudioOutputFormatImpl.getDefaultOutputFormat();\r\n        }\r\n        return this.privAudioStream;\r\n    }\r\n\r\n    public endAudioStream(): void {\r\n        if (this.privAudioStream !== null && !this.privAudioStream.isClosed) {\r\n            this.privAudioStream.close();\r\n        }\r\n    }\r\n\r\n    public complete(): void {\r\n        if (this.privTimeoutToken !== undefined) {\r\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\r\n            clearTimeout(this.privTimeoutToken);\r\n        }\r\n        this.endAudioStream();\r\n    }\r\n\r\n    private resetTurnEndTimeout(): void {\r\n        if (this.privTimeoutToken !== undefined) {\r\n            // eslint-disable-next-line @typescript-eslint/no-unsafe-argument\r\n            clearTimeout(this.privTimeoutToken);\r\n        }\r\n        this.privTimeoutToken = setTimeout((): void => {\r\n            this.privTurnManager.CompleteTurn(this.privRequestId);\r\n            return;\r\n        }, 2000);\r\n    }\r\n}\r\n"],"mappings":"AAAA;AACA;AAEA,SAASA,qBAAqB,QAAQ,mCAAmC;AACzE,SAASC,iBAAiB,QAAmC,mCAAmC;AAEhG,SAAkCC,qBAAqB,QAAQ,8CAA8C;AAE7G,OAAM,MAAOC,sBAAsB;EAO/BC,YAAmBC,OAAsC,EAAEC,SAAiB;IACxE,IAAI,CAACC,aAAa,GAAGD,SAAS;IAC9B,IAAI,CAACE,eAAe,GAAG,KAAK;IAC5B,IAAI,CAACC,eAAe,GAAG,IAAI;IAC3B,IAAI,CAACC,eAAe,GAAGL,OAAO;IAC9B,IAAI,CAACM,mBAAmB,EAAE;EAC9B;EAEA,IAAWC,WAAWA,CAAA;IAClB;IACA,IAAI,CAACD,mBAAmB,EAAE;IAC1B,OAAO,IAAI,CAACF,eAAe;EAC/B;EAEOI,sBAAsBA,CAACC,OAAgC,EAAEC,WAAmC;IAC/F,IAAID,OAAO,CAACE,qBAAqB,KAAKd,qBAAqB,CAACe,iBAAiB,EAAE;MAC3E,IAAI,CAACR,eAAe,GAAGR,iBAAiB,CAACiB,gBAAgB,EAA+B;MACxF,IAAI,CAACT,eAAe,CAACU,MAAM,GAAIJ,WAAW,KAAKK,SAAS,GAAIL,WAAW,GAAGf,qBAAqB,CAACqB,sBAAsB,EAAE;;IAE5H,OAAO,IAAI,CAACZ,eAAe;EAC/B;EAEOa,cAAcA,CAAA;IACjB,IAAI,IAAI,CAACb,eAAe,KAAK,IAAI,IAAI,CAAC,IAAI,CAACA,eAAe,CAACc,QAAQ,EAAE;MACjE,IAAI,CAACd,eAAe,CAACe,KAAK,EAAE;;EAEpC;EAEOC,QAAQA,CAAA;IACX,IAAI,IAAI,CAACC,gBAAgB,KAAKN,SAAS,EAAE;MACrC;MACAO,YAAY,CAAC,IAAI,CAACD,gBAAgB,CAAC;;IAEvC,IAAI,CAACJ,cAAc,EAAE;EACzB;EAEQX,mBAAmBA,CAAA;IACvB,IAAI,IAAI,CAACe,gBAAgB,KAAKN,SAAS,EAAE;MACrC;MACAO,YAAY,CAAC,IAAI,CAACD,gBAAgB,CAAC;;IAEvC,IAAI,CAACA,gBAAgB,GAAGE,UAAU,CAAC,MAAW;MAC1C,IAAI,CAAClB,eAAe,CAACmB,YAAY,CAAC,IAAI,CAACtB,aAAa,CAAC;MACrD;IACJ,CAAC,EAAE,IAAI,CAAC;EACZ"},"metadata":{},"sourceType":"module","externalDependencies":[]}